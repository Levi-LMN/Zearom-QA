{% extends "base.html" %}

{% block title %}{{ testing_session.name }} - Zearom QA{% endblock %}
{% block page_title %}{{ testing_session.name }}{% endblock %}

{% block header_actions %}
<div class="flex space-x-2">
    <a href="{{ url_for('new_finding', session_id=testing_session.id) }}" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
        <i class="fas fa-bug mr-2"></i>New Finding
    </a>
    <a href="{{ url_for('edit_session', session_id=testing_session.id) }}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
        <i class="fas fa-edit mr-2"></i>Edit
    </a>
    <a href="{{ url_for('project_detail', project_id=testing_session.project_id) }}" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
        <i class="fas fa-arrow-left mr-2"></i>Back to Project
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Session Info Card -->
<div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg shadow-md p-6 mb-6 border border-blue-100">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div>
            <p class="text-sm font-medium text-gray-600 mb-1">Project</p>
            <a href="{{ url_for('project_detail', project_id=testing_session.project_id) }}" class="text-blue-600 hover:text-blue-700 font-semibold text-lg">
                <i class="fas fa-folder mr-1"></i>{{ testing_session.project.name }}
            </a>
        </div>
        <div>
            <p class="text-sm font-medium text-gray-600 mb-1">Status</p>
            <div>
                {% if testing_session.status == 'Active' %}
                    <span class="inline-flex items-center px-3 py-1 bg-green-100 text-green-700 text-sm font-semibold rounded-full">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>Active
                    </span>
                {% elif testing_session.status == 'Completed' %}
                    <span class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-700 text-sm font-semibold rounded-full">
                        <i class="fas fa-check-circle mr-1"></i>Completed
                    </span>
                {% else %}
                    <span class="inline-flex items-center px-3 py-1 bg-gray-100 text-gray-700 text-sm font-semibold rounded-full">
                        <i class="fas fa-archive mr-1"></i>Archived
                    </span>
                {% endif %}
            </div>
        </div>
        <div>
            <p class="text-sm font-medium text-gray-600 mb-1">Created</p>
            <p class="text-gray-800 font-medium">
                <i class="fas fa-calendar-alt text-gray-400 mr-1"></i>
                {{ testing_session.created_at.strftime('%b %d, %Y') }}
            </p>
        </div>
        <div>
            <p class="text-sm font-medium text-gray-600 mb-1">Total Findings</p>
            <p class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                {{ all_findings|length }}
            </p>
        </div>
    </div>
    {% if testing_session.description %}
    <div class="mt-6 pt-6 border-t border-blue-200">
        <p class="text-sm font-medium text-gray-600 mb-2">
            <i class="fas fa-info-circle mr-1"></i>Description
        </p>
        <p class="text-gray-700 leading-relaxed">{{ testing_session.description }}</p>
    </div>
    {% endif %}
</div>

<!-- Findings Stats Grid -->
<div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow-md p-5 border-l-4 border-gray-400 hover:shadow-lg transition">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">Total</p>
                <p class="text-3xl font-bold text-gray-800 mt-1">{{ all_findings|length }}</p>
            </div>
            <div class="bg-gray-100 rounded-full p-3">
                <i class="fas fa-list text-gray-600 text-xl"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-5 border-l-4 border-red-500 hover:shadow-lg transition">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">Critical</p>
                <p class="text-3xl font-bold text-red-600 mt-1">{{ all_findings|selectattr('severity', 'equalto', 'Critical')|list|length }}</p>
            </div>
            <div class="bg-red-100 rounded-full p-3">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-5 border-l-4 border-orange-500 hover:shadow-lg transition">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">High</p>
                <p class="text-3xl font-bold text-orange-600 mt-1">{{ all_findings|selectattr('severity', 'equalto', 'High')|list|length }}</p>
            </div>
            <div class="bg-orange-100 rounded-full p-3">
                <i class="fas fa-arrow-up text-orange-600 text-xl"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-5 border-l-4 border-yellow-500 hover:shadow-lg transition">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">Medium</p>
                <p class="text-3xl font-bold text-yellow-600 mt-1">{{ all_findings|selectattr('severity', 'equalto', 'Medium')|list|length }}</p>
            </div>
            <div class="bg-yellow-100 rounded-full p-3">
                <i class="fas fa-minus text-yellow-600 text-xl"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-5 border-l-4 border-blue-500 hover:shadow-lg transition">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">Low</p>
                <p class="text-3xl font-bold text-blue-600 mt-1">{{ all_findings|selectattr('severity', 'equalto', 'Low')|list|length }}</p>
            </div>
            <div class="bg-blue-100 rounded-full p-3">
                <i class="fas fa-arrow-down text-blue-600 text-xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Findings List -->
<div class="bg-white rounded-lg shadow-lg">
    <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
        <div class="flex items-center justify-between">
            <h3 class="text-xl font-bold text-gray-800">
                <i class="fas fa-bug text-red-500 mr-2"></i>
                Findings
                <span class="text-sm font-normal text-gray-600 ml-2">
                    ({{ findings_pagination.total }} total)
                </span>
            </h3>
            <a href="{{ url_for('new_finding', session_id=testing_session.id) }}"
               class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition shadow-md">
                <i class="fas fa-plus mr-2"></i>Add Finding
            </a>
        </div>
    </div>

    <div class="p-6">
        {% if findings_pagination.items %}
            <div class="space-y-4">
                {% for finding in findings_pagination.items %}
                <div class="border border-gray-200 rounded-lg hover:shadow-md transition-all duration-200 overflow-hidden">
                    <div class="p-6">
                        <!-- Finding Header -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <div class="flex items-center flex-wrap gap-2 mb-3">
                                    <!-- Severity Badge -->
                                    {% if finding.severity == 'Critical' %}
                                        <span class="inline-flex items-center px-3 py-1 bg-red-100 text-red-700 text-sm font-bold rounded-full">
                                            <i class="fas fa-exclamation-circle mr-1"></i>Critical
                                        </span>
                                    {% elif finding.severity == 'High' %}
                                        <span class="inline-flex items-center px-3 py-1 bg-orange-100 text-orange-700 text-sm font-bold rounded-full">
                                            <i class="fas fa-exclamation-triangle mr-1"></i>High
                                        </span>
                                    {% elif finding.severity == 'Medium' %}
                                        <span class="inline-flex items-center px-3 py-1 bg-yellow-100 text-yellow-700 text-sm font-bold rounded-full">
                                            <i class="fas fa-exclamation mr-1"></i>Medium
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-700 text-sm font-bold rounded-full">
                                            <i class="fas fa-info-circle mr-1"></i>Low
                                        </span>
                                    {% endif %}

                                    <!-- Status Dropdown -->
                                    <form class="status-form inline-block" data-finding-id="{{ finding.id }}">
                                        <select name="status"
                                                class="status-select px-3 py-1 rounded-full text-sm font-semibold border-0 cursor-pointer transition
                                                {% if finding.status == 'Open' %}bg-red-100 text-red-700
                                                {% elif finding.status == 'In Progress' %}bg-yellow-100 text-yellow-700
                                                {% elif finding.status == 'Resolved' %}bg-green-100 text-green-700
                                                {% else %}bg-gray-100 text-gray-700{% endif %}"
                                                onchange="updateFindingStatus({{ finding.id }}, this.value)">
                                            <option value="Open" {% if finding.status == 'Open' %}selected{% endif %}>Open</option>
                                            <option value="In Progress" {% if finding.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                                            <option value="Resolved" {% if finding.status == 'Resolved' %}selected{% endif %}>Resolved</option>
                                            <option value="Closed" {% if finding.status == 'Closed' %}selected{% endif %}>Closed</option>
                                        </select>
                                    </form>

                                    <!-- Category Badge -->
                                    {% if finding.category %}
                                        <span class="inline-flex items-center px-3 py-1 text-white text-sm font-bold rounded-full"
                                              style="background-color: {{ finding.category.color }}">
                                            <i class="fas fa-tag mr-1"></i>{{ finding.category.name }}
                                        </span>
                                    {% endif %}
                                </div>

                                <!-- Finding Title -->
                                <a href="{{ url_for('finding_detail', finding_id=finding.id) }}"
                                   class="block group">
                                    <h4 class="text-xl font-bold text-gray-800 group-hover:text-blue-600 transition mb-2">
                                        {{ finding.title }}
                                    </h4>
                                </a>

                                <!-- Finding Description with Rich Text Support -->
                                {% if finding.description %}
                                <div class="finding-description text-gray-600 mb-4 line-clamp-3">
                                    {{ finding.description|safe }}
                                </div>
                                {% else %}
                                <p class="text-gray-400 italic mb-4">No description provided</p>
                                {% endif %}

                                <!-- Finding Meta Information -->
                                <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500">
                                    <span class="flex items-center">
                                        <i class="fas fa-user text-gray-400 mr-2"></i>
                                        <span class="font-medium">{{ finding.creator.name or finding.creator.email }}</span>
                                    </span>
                                    <span class="flex items-center">
                                        <i class="fas fa-clock text-gray-400 mr-2"></i>
                                        {{ finding.created_at.strftime('%b %d, %Y at %I:%M %p') }}
                                    </span>
                                    {% if finding.screenshots %}
                                        <span class="flex items-center">
                                            <i class="fas fa-images text-gray-400 mr-2"></i>
                                            {{ finding.screenshots|length }} screenshot{{ 's' if finding.screenshots|length != 1 else '' }}
                                        </span>
                                    {% endif %}
                                    {% if finding.updated_at and finding.updated_at != finding.created_at %}
                                        <span class="flex items-center">
                                            <i class="fas fa-edit text-gray-400 mr-2"></i>
                                            Updated {{ finding.updated_at.strftime('%b %d, %Y') }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex flex-col space-y-2 ml-4">
                                <a href="{{ url_for('finding_detail', finding_id=finding.id) }}"
                                   class="text-blue-600 hover:text-blue-700 p-2 hover:bg-blue-50 rounded-lg transition"
                                   title="View Details">
                                    <i class="fas fa-eye text-lg"></i>
                                </a>
                                <a href="{{ url_for('edit_finding', finding_id=finding.id) }}"
                                   class="text-green-600 hover:text-green-700 p-2 hover:bg-green-50 rounded-lg transition"
                                   title="Edit">
                                    <i class="fas fa-edit text-lg"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if findings_pagination.pages > 1 %}
            <div class="mt-8 flex items-center justify-between border-t border-gray-200 pt-6">
                <div class="text-sm text-gray-700 font-medium">
                    Showing
                    <span class="font-bold text-gray-900">{{ ((findings_pagination.page - 1) * findings_pagination.per_page) + 1 }}</span>
                    to
                    <span class="font-bold text-gray-900">{{ min(findings_pagination.page * findings_pagination.per_page, findings_pagination.total) }}</span>
                    of
                    <span class="font-bold text-gray-900">{{ findings_pagination.total }}</span>
                    findings
                </div>
                <div class="flex space-x-2">
                    {% if findings_pagination.has_prev %}
                        <a href="{{ url_for('session_detail', session_id=testing_session.id, page=findings_pagination.prev_num) }}"
                           class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-md">
                            <i class="fas fa-chevron-left mr-2"></i>Previous
                        </a>
                    {% else %}
                        <span class="inline-flex items-center px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed">
                            <i class="fas fa-chevron-left mr-2"></i>Previous
                        </span>
                    {% endif %}

                    <!-- Page Numbers -->
                    <div class="flex space-x-1">
                        {% for page_num in findings_pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                            {% if page_num %}
                                {% if page_num == findings_pagination.page %}
                                    <span class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold shadow-md">{{ page_num }}</span>
                                {% else %}
                                    <a href="{{ url_for('session_detail', session_id=testing_session.id, page=page_num) }}"
                                       class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                                        {{ page_num }}
                                    </a>
                                {% endif %}
                            {% else %}
                                <span class="px-2 py-2 text-gray-400">...</span>
                            {% endif %}
                        {% endfor %}
                    </div>

                    {% if findings_pagination.has_next %}
                        <a href="{{ url_for('session_detail', session_id=testing_session.id, page=findings_pagination.next_num) }}"
                           class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-md">
                            Next<i class="fas fa-chevron-right ml-2"></i>
                        </a>
                    {% else %}
                        <span class="inline-flex items-center px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed">
                            Next<i class="fas fa-chevron-right ml-2"></i>
                        </span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        {% else %}
            <!-- Empty State -->
            <div class="text-center py-16">
                <div class="inline-block p-6 bg-gray-100 rounded-full mb-4">
                    <i class="fas fa-bug text-gray-400 text-6xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-700 mb-2">No Findings Yet</h3>
                <p class="text-gray-500 mb-8 max-w-md mx-auto">
                    Start documenting QA issues and bugs for this testing session to track and resolve them effectively.
                </p>
                <a href="{{ url_for('new_finding', session_id=testing_session.id) }}"
                   class="inline-flex items-center bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 transition shadow-lg">
                    <i class="fas fa-plus mr-2"></i>Create First Finding
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Styles for Rich Text Display and Line Clamping -->
<style>
/* Rich text content styling */
.finding-description h1 { font-size: 1.5em; font-weight: bold; margin: 0.5em 0; }
.finding-description h2 { font-size: 1.3em; font-weight: bold; margin: 0.5em 0; }
.finding-description h3 { font-size: 1.1em; font-weight: bold; margin: 0.5em 0; }
.finding-description p { margin: 0.5em 0; line-height: 1.6; }
.finding-description ul, .finding-description ol { margin: 0.5em 0; padding-left: 1.5em; }
.finding-description ul { list-style-type: disc; }
.finding-description ol { list-style-type: decimal; }
.finding-description strong { font-weight: bold; }
.finding-description em { font-style: italic; }
.finding-description u { text-decoration: underline; }

/* Line clamp for descriptions */
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>

<!-- JavaScript for Status Updates -->
<script>
function updateFindingStatus(findingId, newStatus) {
    const select = event.target;
    const originalValue = select.dataset.originalValue || select.value;

    fetch(`/finding/${findingId}/update-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `status=${encodeURIComponent(newStatus)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update select styling based on new status
            select.className = `status-select px-3 py-1 rounded-full text-sm font-semibold border-0 cursor-pointer transition ${
                newStatus === 'Open' ? 'bg-red-100 text-red-700' :
                newStatus === 'In Progress' ? 'bg-yellow-100 text-yellow-700' :
                newStatus === 'Resolved' ? 'bg-green-100 text-green-700' :
                'bg-gray-100 text-gray-700'
            }`;
            select.dataset.originalValue = newStatus;

            // Show success notification
            showNotification('Status updated successfully', 'success');
        } else {
            select.value = originalValue;
            showNotification('Failed to update status', 'error');
        }
    })
    .catch(error => {
        select.value = originalValue;
        showNotification('An error occurred', 'error');
        console.error('Error:', error);
    });
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => notification.style.transform = 'translateY(0)', 10);

    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.transform = 'translateY(-100px)';
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Store original values on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.status-select').forEach(select => {
        select.dataset.originalValue = select.value;
    });
});
</script>
{% endblock %}