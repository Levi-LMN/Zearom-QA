{% extends "base.html" %}

{% block title %}{% if testing_session %}Edit{% else %}New{% endif %} Session - Zearom QA{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-6">
        <h1 class="text-gray-900 mb-1">{% if testing_session %}Edit{% else %}New{% endif %} Testing Session</h1>
        <p class="text-sm text-gray-500">{% if testing_session %}Update session details{% else %}Create a new testing session for {{ project.name }}{% endif %}</p>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <form method="POST">
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Session Name *</label>
                    <input type="text" name="name" required
                           value="{{ testing_session.name if testing_session else '' }}"
                           class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="e.g., Sprint 1 Testing">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <!-- Toolbar -->
                        <div class="bg-gray-50 border-b border-gray-200 px-3 py-2 flex flex-wrap gap-1">
                            <button type="button" onclick="formatText('bold')" class="p-2 hover:bg-gray-200 rounded" title="Bold">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M6 4v12h4.5c1.76 0 3.5-1.24 3.5-3.5 0-1.4-.7-2.6-1.9-3.1.7-.5 1.4-1.3 1.4-2.4 0-2.26-1.74-3-3.5-3H6zm2 2h2c.83 0 1.5.67 1.5 1.5S10.83 9 10 9H8V6zm0 5h2.5c1.1 0 2 .9 2 2s-.9 2-2 2H8v-4z"/>
                                </svg>
                            </button>
                            <button type="button" onclick="formatText('italic')" class="p-2 hover:bg-gray-200 rounded" title="Italic">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 4v2h2.21l-3.42 8H6v2h8v-2h-2.21l3.42-8H18V4h-8z"/>
                                </svg>
                            </button>
                            <button type="button" onclick="formatText('underline')" class="p-2 hover:bg-gray-200 rounded" title="Underline">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 3c-2.76 0-5 2.24-5 5v5h2V8c0-1.65 1.35-3 3-3s3 1.35 3 3v5h2V8c0-2.76-2.24-5-5-5zm-6 14h12v2H4v-2z"/>
                                </svg>
                            </button>
                            <div class="w-px h-6 bg-gray-300 mx-1"></div>
                            <button type="button" onclick="formatText('insertUnorderedList')" class="p-2 hover:bg-gray-200 rounded" title="Bullet List">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm4-11h10v2H8V7zm0 6h10v2H8v-2zm0 6h10v2H8v-2z"/>
                                </svg>
                            </button>
                            <button type="button" onclick="formatText('insertOrderedList')" class="p-2 hover:bg-gray-200 rounded" title="Numbered List">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M3 4h2v2H3V4zm0 4h2v2H3V8zm0 4h2v2H3v-2zm5-7h10v2H8V5zm0 6h10v2H8v-2zm0 6h10v2H8v-2z"/>
                                </svg>
                            </button>
                            <div class="w-px h-6 bg-gray-300 mx-1"></div>
                            <button type="button" onclick="formatText('formatBlock', 'h3')" class="p-2 hover:bg-gray-200 rounded text-xs font-semibold" title="Heading">H</button>
                        </div>

                        <!-- Editor -->
                        <div id="editor"
                             contenteditable="true"
                             class="min-h-[150px] p-4 focus:outline-none text-sm"
                             style="max-height: 300px; overflow-y: auto;"
                             placeholder="Describe the testing session scope and objectives..."></div>

                        <!-- Hidden textarea for form submission -->
                        <textarea name="description" id="description" class="hidden"></textarea>
                    </div>
                </div>

                {% if testing_session %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select name="status"
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="Active" {% if testing_session.status == 'Active' %}selected{% endif %}>Active</option>
                        <option value="Completed" {% if testing_session.status == 'Completed' %}selected{% endif %}>Completed</option>
                        <option value="Archived" {% if testing_session.status == 'Archived' %}selected{% endif %}>Archived</option>
                    </select>
                </div>
                {% endif %}

                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <a href="{{ url_for('project_detail', project_id=project.id) if not testing_session else url_for('session_detail', session_id=testing_session.id) }}"
                       class="px-5 py-2.5 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancel
                    </a>
                    <button type="submit" class="btn-primary text-white px-5 py-2.5 rounded-lg text-sm font-medium">
                        {% if testing_session %}Update{% else %}Create{% endif %} Session
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
#editor[contenteditable]:empty:before {
    content: attr(placeholder);
    color: #9CA3AF;
    pointer-events: none;
}

#editor h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 1rem 0 0.5rem 0;
    color: #1F2937;
}

#editor ul, #editor ol {
    margin: 0.5rem 0;
    padding-left: 2rem;
}

#editor ul {
    list-style-type: disc;
}

#editor ol {
    list-style-type: decimal;
}

#editor li {
    margin: 0.25rem 0;
}

#editor strong {
    font-weight: 600;
}

#editor em {
    font-style: italic;
}

#editor u {
    text-decoration: underline;
}

#editor p {
    margin: 0.5rem 0;
}
</style>

<script>
function formatText(command, value = null) {
    document.execCommand(command, false, value);
    document.getElementById('editor').focus();
}

// Initialize editor with existing content
window.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('editor');

    // Load existing content if editing
    {% if testing_session and testing_session.description %}
    // Parse the HTML content and set it in the editor
    editor.innerHTML = {{ testing_session.description|tojson }};
    {% endif %}
});

// Sync editor content to hidden textarea before form submission
document.querySelector('form').addEventListener('submit', function(e) {
    const editor = document.getElementById('editor');
    const description = document.getElementById('description');

    // Get the HTML content from the editor
    let editorContent = editor.innerHTML.trim();

    // Clean up empty paragraphs and divs
    editorContent = editorContent.replace(/<p><br><\/p>/g, '<br>');
    editorContent = editorContent.replace(/<p>\s*<\/p>/g, '');
    editorContent = editorContent.replace(/<div><br><\/div>/g, '<br>');
    editorContent = editorContent.replace(/<div>\s*<\/div>/g, '');

    // Set the cleaned content to the hidden textarea
    description.value = editorContent;
});
</script>
{% endblock %}