{% extends "base.html" %}

{% block title %}{{ finding.title }} - Zearom QA{% endblock %}
{% block page_title %}Finding Details{% endblock %}

{% block header_actions %}
<div class="flex space-x-2">
    <a href="{{ url_for('edit_finding', finding_id=finding.id) }}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
        <i class="fas fa-edit mr-2"></i>Edit
    </a>
    <a href="{{ url_for('session_detail', session_id=finding.session_id) }}" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
        <i class="fas fa-arrow-left mr-2"></i>Back to Session
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Finding Header Card -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex items-center space-x-2 mb-4">
        {% if finding.severity == 'Critical' %}
            <span class="px-3 py-1 bg-red-100 text-red-700 text-sm font-bold rounded">Critical</span>
        {% elif finding.severity == 'High' %}
            <span class="px-3 py-1 bg-orange-100 text-orange-700 text-sm font-bold rounded">High</span>
        {% elif finding.severity == 'Medium' %}
            <span class="px-3 py-1 bg-yellow-100 text-yellow-700 text-sm font-bold rounded">Medium</span>
        {% else %}
            <span class="px-3 py-1 bg-blue-100 text-blue-700 text-sm font-bold rounded">Low</span>
        {% endif %}

        <span class="px-3 py-1 bg-gray-100 text-gray-700 text-sm font-bold rounded">{{ finding.status }}</span>

        {% if finding.category %}
            <span class="px-3 py-1 text-white text-sm font-bold rounded" style="background-color: {{ finding.category.color }}">
                {{ finding.category.name }}
            </span>
        {% endif %}
    </div>

    <h2 class="text-2xl font-bold text-gray-800 mb-6">{{ finding.title }}</h2>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 pt-4 border-t border-gray-200">
        <div>
            <p class="text-sm text-gray-600 mb-1">Project</p>
            <a href="{{ url_for('project_detail', project_id=finding.session.project_id) }}" class="text-blue-600 hover:text-blue-700 font-medium">
                {{ finding.session.project.name }}
            </a>
        </div>
        <div>
            <p class="text-sm text-gray-600 mb-1">Testing Session</p>
            <a href="{{ url_for('session_detail', session_id=finding.session_id) }}" class="text-blue-600 hover:text-blue-700 font-medium">
                {{ finding.session.name }}
            </a>
        </div>
        <div>
            <p class="text-sm text-gray-600 mb-1">Created By</p>
            <p class="text-gray-800 font-medium">{{ finding.creator.name or finding.creator.email }}</p>
        </div>
        <div>
            <p class="text-sm text-gray-600 mb-1">Created At</p>
            <p class="text-gray-800">{{ finding.created_at.strftime('%b %d, %Y %I:%M %p') }}</p>
        </div>
    </div>

    {% if finding.updated_at and finding.updated_at != finding.created_at %}
    <div class="pt-4 mt-4 border-t border-gray-200">
        <p class="text-sm text-gray-600">Last updated: {{ finding.updated_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
    </div>
    {% endif %}
</div>

<!-- Description Card -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Description</h3>
    {% if finding.description %}
        <div class="text-gray-700 finding-description">
            {{ finding.description|safe }}
        </div>
    {% else %}
        <p class="text-gray-500 italic">No description provided</p>
    {% endif %}
</div>

<!-- Screenshots Card -->
{% if finding.screenshots %}
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Screenshots ({{ finding.screenshots|length }})</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for screenshot in finding.screenshots %}
        <div class="screenshot-thumb cursor-pointer" data-src="/{{ screenshot.filepath }}" data-name="{{ screenshot.filename }}">
            <img src="/{{ screenshot.filepath }}" alt="{{ screenshot.filename }}" class="w-full h-64 object-cover rounded-lg border border-gray-200 hover:border-blue-500 transition">
            <p class="text-sm text-gray-600 mt-2">{{ screenshot.filename }}</p>
            <p class="text-xs text-gray-500">{{ screenshot.uploaded_at.strftime('%b %d, %Y') }}</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Action Buttons -->
<div class="flex space-x-4">
    <a href="{{ url_for('edit_finding', finding_id=finding.id) }}" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
        <i class="fas fa-edit mr-2"></i>Edit Finding
    </a>
    <button type="button" onclick="confirmDelete()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition">
        <i class="fas fa-trash mr-2"></i>Delete Finding
    </button>
</div>

<form id="deleteForm" method="POST" action="{{ url_for('delete_finding', finding_id=finding.id) }}"></form>

<!-- Modal -->
<div id="modal" class="modal">
    <span class="modal-close">&times;</span>
    <img class="modal-content" id="modalImg">
    <div id="caption"></div>
</div>

<style>
.finding-description h1 { font-size: 2em; font-weight: bold; margin: 0.67em 0; }
.finding-description h2 { font-size: 1.5em; font-weight: bold; margin: 0.75em 0; }
.finding-description h3 { font-size: 1.17em; font-weight: bold; margin: 0.83em 0; }
.finding-description p { margin: 1em 0; line-height: 1.6; }
.finding-description ul, .finding-description ol { margin: 1em 0; padding-left: 2em; }
.finding-description ul { list-style-type: disc; }
.finding-description ol { list-style-type: decimal; }
.finding-description strong { font-weight: bold; }
.finding-description em { font-style: italic; }
.finding-description u { text-decoration: underline; }

.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    padding-top: 50px;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.9);
}

.modal-content {
    margin: auto;
    display: block;
    max-width: 90%;
    max-height: 80vh;
    object-fit: contain;
}

#caption {
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px;
    text-align: center;
    color: #ccc;
    padding: 10px 0;
    font-size: 18px;
}

.modal-close {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
}

.modal-close:hover,
.modal-close:focus {
    color: #bbb;
}
</style>

<script>
function confirmDelete() {
    if (confirm('Are you sure you want to delete this finding?')) {
        document.getElementById('deleteForm').submit();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const captionText = document.getElementById('caption');
    const closeBtn = document.querySelector('.modal-close');

    document.querySelectorAll('.screenshot-thumb').forEach(thumb => {
        thumb.addEventListener('click', function() {
            modal.style.display = 'block';
            modalImg.src = this.dataset.src;
            captionText.textContent = this.dataset.name;
            document.body.style.overflow = 'hidden';
        });
    });

    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    });

    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display === 'block') {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    });
});
</script>
{% endblock %}