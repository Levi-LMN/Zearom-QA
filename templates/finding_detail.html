{% extends "base.html" %}

{% block title %}{{ finding.title }} - Zearom QA{% endblock %}
{% block page_title %}Finding Details{% endblock %}

{% block header_actions %}
<div class="flex space-x-2">
    <a href="{{ url_for('edit_finding', finding_id=finding.id) }}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
        <i class="fas fa-edit mr-2"></i>Edit
    </a>
    <a href="{{ url_for('session_detail', session_id=finding.session_id) }}" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
        <i class="fas fa-arrow-left mr-2"></i>Back to Session
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Finding Header -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex items-start justify-between mb-4">
        <div class="flex-1">
            <div class="flex items-center space-x-2 mb-3">
                {% if finding.severity == 'Critical' %}
                    <span class="px-3 py-1 bg-red-100 text-red-700 text-sm font-bold rounded">Critical</span>
                {% elif finding.severity == 'High' %}
                    <span class="px-3 py-1 bg-orange-100 text-orange-700 text-sm font-bold rounded">High</span>
                {% elif finding.severity == 'Medium' %}
                    <span class="px-3 py-1 bg-yellow-100 text-yellow-700 text-sm font-bold rounded">Medium</span>
                {% else %}
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 text-sm font-bold rounded">Low</span>
                {% endif %}

                <span class="px-3 py-1 bg-gray-100 text-gray-700 text-sm font-bold rounded">{{ finding.status }}</span>

                {% if finding.category %}
                    <span class="px-3 py-1 text-white text-sm font-bold rounded" style="background-color: {{ finding.category.color }}">
                        {{ finding.category.name }}
                    </span>
                {% endif %}
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">{{ finding.title }}</h2>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 pt-6 border-t border-gray-200">
        <div>
            <p class="text-sm text-gray-600 mb-1">Project</p>
            <a href="{{ url_for('project_detail', project_id=finding.session.project_id) }}" class="text-blue-600 hover:text-blue-700 font-medium">
                {{ finding.session.project.name }}
            </a>
        </div>
        <div>
            <p class="text-sm text-gray-600 mb-1">Testing Session</p>
            <a href="{{ url_for('session_detail', session_id=finding.session_id) }}" class="text-blue-600 hover:text-blue-700 font-medium">
                {{ finding.session.name }}
            </a>
        </div>
        <div>
            <p class="text-sm text-gray-600 mb-1">Created By</p>
            <p class="text-gray-800 font-medium">{{ finding.creator.name or finding.creator.email }}</p>
        </div>
        <div>
            <p class="text-sm text-gray-600 mb-1">Created At</p>
            <p class="text-gray-800">{{ finding.created_at.strftime('%b %d, %Y %I:%M %p') }}</p>
        </div>
    </div>

    {% if finding.updated_at and finding.updated_at != finding.created_at %}
    <div class="pt-4 border-t border-gray-200">
        <p class="text-sm text-gray-600">Last updated: {{ finding.updated_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
    </div>
    {% endif %}
</div>

<!-- Description -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Description</h3>
    {% if finding.description %}
        <div class="prose max-w-none text-gray-700 finding-description">
            {{ finding.description|safe }}
        </div>
    {% else %}
        <p class="text-gray-500 italic">No description provided</p>
    {% endif %}
</div>

<!-- Screenshots -->
{% if finding.screenshots %}
<div class="bg-white rounded-lg shadow p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Screenshots ({{ finding.screenshots|length }})</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for screenshot in finding.screenshots %}
        <div class="relative group cursor-pointer" onclick="openModal('{{ screenshot.filepath }}', '{{ screenshot.filename }}')">
            <img src="/{{ screenshot.filepath }}" alt="Screenshot" class="w-full h-64 object-cover rounded-lg border border-gray-200">
            <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex flex-col items-center justify-center">
                <i class="fas fa-search-plus text-white text-3xl mb-2"></i>
                <p class="text-white text-xs text-center px-2">{{ screenshot.filename }}</p>
                <p class="text-white text-xs">{{ screenshot.uploaded_at.strftime('%b %d, %Y') }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="closeModal()">
    <div class="relative max-w-7xl max-h-full" onclick="event.stopPropagation()">
        <button onclick="closeModal()" class="absolute -top-10 right-0 text-white hover:text-gray-300 text-3xl">
            <i class="fas fa-times"></i>
        </button>
        <img id="modalImage" src="" alt="Screenshot" class="max-w-full max-h-screen rounded-lg">
        <p id="modalCaption" class="text-white text-center mt-2"></p>
    </div>
</div>

<script>
    function openModal(imagePath, filename) {
        document.getElementById('imageModal').classList.remove('hidden');
        document.getElementById('modalImage').src = '/' + imagePath;
        document.getElementById('modalCaption').textContent = filename;
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        document.getElementById('imageModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });
</script>
{% endif %}

<!-- Action Buttons -->
<div class="mt-6 flex space-x-4">
    <a href="{{ url_for('edit_finding', finding_id=finding.id) }}" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
        <i class="fas fa-edit mr-2"></i>Edit Finding
    </a>
    <button onclick="if(confirm('Are you sure you want to delete this finding?')) { document.getElementById('deleteForm').submit(); }"
            class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition">
        <i class="fas fa-trash mr-2"></i>Delete Finding
    </button>
</div>

<form id="deleteForm" method="POST" action="{{ url_for('delete_finding', finding_id=finding.id) }}" class="hidden">
</form>

<style>
/* Styling for rich text content */
.finding-description h1 {
    font-size: 2em;
    font-weight: bold;
    margin: 0.67em 0;
}

.finding-description h2 {
    font-size: 1.5em;
    font-weight: bold;
    margin: 0.75em 0;
}

.finding-description h3 {
    font-size: 1.17em;
    font-weight: bold;
    margin: 0.83em 0;
}

.finding-description p {
    margin: 1em 0;
    line-height: 1.6;
}

.finding-description ul,
.finding-description ol {
    margin: 1em 0;
    padding-left: 2em;
}

.finding-description ul {
    list-style-type: disc;
}

.finding-description ol {
    list-style-type: decimal;
}

.finding-description strong {
    font-weight: bold;
}

.finding-description em {
    font-style: italic;
}

.finding-description u {
    text-decoration: underline;
}
</style>
{% endblock %}