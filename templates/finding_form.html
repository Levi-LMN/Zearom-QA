{% extends "base.html" %}

{% block title %}{% if finding %}Edit{% else %}New{% endif %} Finding - Zearom QA{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <div class="mb-6">
        <h1 class="text-gray-900 mb-1">{% if finding %}Edit{% else %}New{% endif %} Finding</h1>
        <p class="text-sm text-gray-500">{% if finding %}Update finding details{% else %}Report a new finding in {{ testing_session.name }}{% endif %}</p>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <form method="POST" enctype="multipart/form-data">
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Title *</label>
                    <input type="text" name="title" required
                           value="{{ finding.title if finding else '' }}"
                           class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="Brief description of the finding">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <!-- Toolbar -->
                        <div class="bg-gray-50 border-b border-gray-200 px-3 py-2 flex flex-wrap gap-1">
                            <button type="button" onclick="formatText('bold')" class="p-2 hover:bg-gray-200 rounded" title="Bold">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M6 4v12h4.5c1.76 0 3.5-1.24 3.5-3.5 0-1.4-.7-2.6-1.9-3.1.7-.5 1.4-1.3 1.4-2.4 0-2.26-1.74-3-3.5-3H6zm2 2h2c.83 0 1.5.67 1.5 1.5S10.83 9 10 9H8V6zm0 5h2.5c1.1 0 2 .9 2 2s-.9 2-2 2H8v-4z"/>
                                </svg>
                            </button>
                            <button type="button" onclick="formatText('italic')" class="p-2 hover:bg-gray-200 rounded" title="Italic">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 4v2h2.21l-3.42 8H6v2h8v-2h-2.21l3.42-8H18V4h-8z"/>
                                </svg>
                            </button>
                            <button type="button" onclick="formatText('underline')" class="p-2 hover:bg-gray-200 rounded" title="Underline">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 3c-2.76 0-5 2.24-5 5v5h2V8c0-1.65 1.35-3 3-3s3 1.35 3 3v5h2V8c0-2.76-2.24-5-5-5zm-6 14h12v2H4v-2z"/>
                                </svg>
                            </button>
                            <div class="w-px h-6 bg-gray-300 mx-1"></div>
                            <button type="button" onclick="formatText('insertUnorderedList')" class="p-2 hover:bg-gray-200 rounded" title="Bullet List">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm4-11h10v2H8V7zm0 6h10v2H8v-2zm0 6h10v2H8v-2z"/>
                                </svg>
                            </button>
                            <button type="button" onclick="formatText('insertOrderedList')" class="p-2 hover:bg-gray-200 rounded" title="Numbered List">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M3 4h2v2H3V4zm0 4h2v2H3V8zm0 4h2v2H3v-2zm5-7h10v2H8V5zm0 6h10v2H8v-2zm0 6h10v2H8v-2z"/>
                                </svg>
                            </button>
                            <div class="w-px h-6 bg-gray-300 mx-1"></div>
                            <button type="button" onclick="formatText('formatBlock', 'h3')" class="p-2 hover:bg-gray-200 rounded text-xs font-semibold" title="Heading">H</button>
                            <button type="button" onclick="insertCode()" class="p-2 hover:bg-gray-200 rounded" title="Code Block">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Editor -->
                        <div id="editor"
                             contenteditable="true"
                             class="min-h-[200px] p-4 focus:outline-none text-sm"
                             style="max-height: 400px; overflow-y: auto;"
                             placeholder="Detailed description, steps to reproduce, expected vs actual behavior..."></div>

                        <!-- Hidden textarea for form submission -->
                        <textarea name="description" id="description" class="hidden"></textarea>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Use the toolbar to format your text</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Severity *</label>
                        <select name="severity" required
                                class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="Critical" {% if finding and finding.severity == 'Critical' %}selected{% endif %}>Critical</option>
                            <option value="High" {% if finding and finding.severity == 'High' %}selected{% endif %}>High</option>
                            <option value="Medium" {% if finding and finding.severity == 'Medium' %}selected{% elif not finding %}selected{% endif %}>Medium</option>
                            <option value="Low" {% if finding and finding.severity == 'Low' %}selected{% endif %}>Low</option>
                        </select>
                    </div>

                    {% if finding %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select name="status"
                                class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="Open" {% if finding.status == 'Open' %}selected{% endif %}>Open</option>
                            <option value="In Progress" {% if finding.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                            <option value="Resolved" {% if finding.status == 'Resolved' %}selected{% endif %}>Resolved</option>
                            <option value="Closed" {% if finding.status == 'Closed' %}selected{% endif %}>Closed</option>
                        </select>
                    </div>
                    {% endif %}
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select name="category_id"
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">No Category</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if finding and finding.category_id == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Module</label>
                        <select name="module_id" id="moduleSelect" onchange="loadSubmodules(this.value)"
                                class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="">No Module</option>
                            {% for module in modules %}
                            <option value="{{ module.id }}" {% if finding and finding.module_id == module.id %}selected{% endif %}>
                                {{ module.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Submodule</label>
                        <select name="submodule_id" id="submoduleSelect"
                                class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="">No Submodule</option>
                            {% if finding and finding.submodule %}
                            <option value="{{ finding.submodule.id }}" selected>{{ finding.submodule.name }}</option>
                            {% endif %}
                        </select>
                    </div>
                </div>

                {% if finding and finding.screenshots %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Existing Screenshots</label>
                    <div class="grid grid-cols-3 gap-3">
                        {% for screenshot in finding.screenshots %}
                        <div class="relative group">
                            <img src="{{ url_for('static', filename='uploads/' + screenshot.filename) }}"
                                 alt="Screenshot"
                                 class="w-full h-32 object-cover rounded-lg border border-gray-200">
                            <label class="absolute top-2 right-2">
                                <input type="checkbox" name="keep_screenshots" value="{{ screenshot.id }}" checked
                                       class="w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Uncheck to remove screenshots</p>
                </div>
                {% endif %}

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Screenshots</label>

                    <!-- Upload Area -->
                    <div id="dropArea" class="border-2 border-dashed border-gray-200 rounded-lg p-6 text-center hover:border-green-500 transition">
                        <svg class="w-10 h-10 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <input type="file" name="screenshots" multiple accept="image/*"
                               class="hidden" id="screenshots"
                               onchange="handleFileSelect(this)">
                        <label for="screenshots" class="cursor-pointer">
                            <span class="text-sm text-green-600 font-medium hover:text-green-700">Upload screenshots</span>
                            <p class="text-xs text-gray-500 mt-1">or drag and drop</p>
                        </label>
                        <button type="button" onclick="handlePaste()" class="mt-3 px-4 py-2 text-sm bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            Paste from Clipboard (Ctrl+V)
                        </button>
                    </div>

                    <!-- Preview Area -->
                    <div id="previewArea" class="mt-4 hidden">
                        <div class="flex items-center justify-between mb-3">
                            <p class="text-sm font-medium text-gray-700">Selected Screenshots (<span id="previewCount">0</span>)</p>
                            <button type="button" onclick="clearAllPreviews()" class="text-xs text-red-600 hover:text-red-700">
                                Clear All
                            </button>
                        </div>
                        <div id="previewGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                            <!-- Preview items will be inserted here -->
                        </div>
                    </div>

                    <p class="text-xs text-gray-500 mt-2">Supports: JPG, PNG, GIF. You can also paste screenshots directly from clipboard.</p>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <a href="{{ url_for('session_detail', session_id=testing_session.id) if not finding else url_for('finding_detail', finding_id=finding.id) }}"
                       class="px-5 py-2.5 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancel
                    </a>
                    <button type="submit" class="btn-primary text-white px-5 py-2.5 rounded-lg text-sm font-medium">
                        {% if finding %}Update{% else %}Create{% endif %} Finding
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
#editor[contenteditable]:empty:before {
    content: attr(placeholder);
    color: #9CA3AF;
    pointer-events: none;
}

#editor h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 1rem 0 0.5rem 0;
    color: #1F2937;
}

#editor ul, #editor ol {
    margin: 0.5rem 0;
    padding-left: 2rem;
}

#editor ul {
    list-style-type: disc;
}

#editor ol {
    list-style-type: decimal;
}

#editor li {
    margin: 0.25rem 0;
}

#editor code {
    background-color: #F3F4F6;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-family: monospace;
    font-size: 0.875em;
}

#editor pre {
    background-color: #F3F4F6;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1rem 0;
}

#editor pre code {
    background: none;
    padding: 0;
}

#editor strong {
    font-weight: 600;
}

#editor em {
    font-style: italic;
}

#editor u {
    text-decoration: underline;
}

#editor p {
    margin: 0.5rem 0;
}

#editor p:empty {
    margin: 0;
}

#dropArea.drag-over {
    border-color: #10b981;
    background-color: #f0fdf4;
}

.preview-item {
    position: relative;
    aspect-ratio: 1;
    border-radius: 0.5rem;
    overflow: hidden;
    border: 2px solid #e5e7eb;
    background: #f9fafb;
}

.preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.preview-item .remove-btn {
    position: absolute;
    top: 0.25rem;
    right: 0.25rem;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 0.25rem;
    width: 1.5rem;
    height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
}

.preview-item:hover .remove-btn {
    opacity: 1;
}

.preview-item .remove-btn:hover {
    background: rgba(220, 38, 38, 1);
}
</style>

<script>
// Global array to store selected files
let selectedFiles = [];

function formatText(command, value = null) {
    document.execCommand(command, false, value);
    document.getElementById('editor').focus();
}

function insertCode() {
    const selection = window.getSelection();
    const text = selection.toString();

    if (text) {
        document.execCommand('insertHTML', false, `<code>${text}</code>`);
    } else {
        document.execCommand('insertHTML', false, '<pre><code>// Your code here</code></pre>');
    }
    document.getElementById('editor').focus();
}

// Handle file selection from input
function handleFileSelect(input) {
    const files = Array.from(input.files);
    addFilesToSelection(files);
}

// Add files to selection and update preview
function addFilesToSelection(files) {
    files.forEach(file => {
        if (file.type.startsWith('image/')) {
            selectedFiles.push(file);
        }
    });
    updatePreview();
}

// Update preview grid
function updatePreview() {
    const previewArea = document.getElementById('previewArea');
    const previewGrid = document.getElementById('previewGrid');
    const previewCount = document.getElementById('previewCount');

    if (selectedFiles.length === 0) {
        previewArea.classList.add('hidden');
        return;
    }

    previewArea.classList.remove('hidden');
    previewCount.textContent = selectedFiles.length;
    previewGrid.innerHTML = '';

    selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
                <img src="${e.target.result}" alt="Preview">
                <button type="button" class="remove-btn" onclick="removeFile(${index})" title="Remove">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            `;
            previewGrid.appendChild(previewItem);
        };
        reader.readAsDataURL(file);
    });
}

// Remove file from selection
function removeFile(index) {
    selectedFiles.splice(index, 1);
    updatePreview();
    updateFileInput();
}

// Clear all previews
function clearAllPreviews() {
    selectedFiles = [];
    updatePreview();
    updateFileInput();
}

// Update the file input with current selection
function updateFileInput() {
    const input = document.getElementById('screenshots');
    const dataTransfer = new DataTransfer();

    selectedFiles.forEach(file => {
        dataTransfer.items.add(file);
    });

    input.files = dataTransfer.files;
}

// Handle paste from clipboard
async function handlePaste() {
    try {
        const clipboardItems = await navigator.clipboard.read();

        for (const item of clipboardItems) {
            for (const type of item.types) {
                if (type.startsWith('image/')) {
                    const blob = await item.getType(type);
                    const file = new File([blob], `pasted-${Date.now()}.png`, { type: blob.type });
                    addFilesToSelection([file]);
                }
            }
        }

        updateFileInput();
    } catch (err) {
        alert('Unable to access clipboard. Please use Ctrl+V or manually upload files.');
        console.error('Clipboard access error:', err);
    }
}

// Global paste event listener
document.addEventListener('paste', function(e) {
    const items = e.clipboardData.items;
    const files = [];

    for (let i = 0; i < items.length; i++) {
        if (items[i].type.startsWith('image/')) {
            const blob = items[i].getAsFile();
            const file = new File([blob], `pasted-${Date.now()}.png`, { type: blob.type });
            files.push(file);
        }
    }

    if (files.length > 0) {
        e.preventDefault();
        addFilesToSelection(files);
        updateFileInput();
    }
});

// Drag and drop functionality
const dropArea = document.getElementById('dropArea');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, function() {
        dropArea.classList.add('drag-over');
    }, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, function() {
        dropArea.classList.remove('drag-over');
    }, false);
});

dropArea.addEventListener('drop', function(e) {
    const dt = e.dataTransfer;
    const files = Array.from(dt.files);
    addFilesToSelection(files);
    updateFileInput();
}, false);

// Load submodules based on selected module
async function loadSubmodules(moduleId) {
    const submoduleSelect = document.getElementById('submoduleSelect');
    submoduleSelect.innerHTML = '<option value="">No Submodule</option>';

    if (!moduleId) return;

    try {
        const response = await fetch(`/api/module/${moduleId}/submodules`);
        const submodules = await response.json();

        submodules.forEach(submodule => {
            const option = document.createElement('option');
            option.value = submodule.id;
            option.textContent = submodule.name;
            submoduleSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load submodules:', error);
    }
}

// Initialize editor with existing content
window.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('editor');

    {% if finding and finding.description %}
    editor.innerHTML = {{ finding.description|tojson }};
    {% endif %}

    editor.addEventListener('input', function() {
        editor.style.border = '';
        const errorMsg = document.getElementById('editorError');
        if (errorMsg) errorMsg.remove();
    });

    // Load submodules if module is already selected
    {% if finding and finding.module_id %}
    loadSubmodules({{ finding.module_id }});
    {% endif %}
});

// Sync editor content to hidden textarea before form submission
document.querySelector('form').addEventListener('submit', function(e) {
    const editor = document.getElementById('editor');
    const description = document.getElementById('description');

    const editorContent = editor.innerHTML.trim();
    const textContent = editor.innerText.trim();

    if (!textContent || textContent === '') {
        e.preventDefault();
        editor.focus();
        editor.style.border = '2px solid #ef4444';

        let errorMsg = document.getElementById('editorError');
        if (!errorMsg) {
            errorMsg = document.createElement('p');
            errorMsg.id = 'editorError';
            errorMsg.className = 'text-xs text-red-600 mt-2';
            errorMsg.textContent = 'Description is required';
            editor.parentElement.parentElement.appendChild(errorMsg);
        }
        return false;
    }

    editor.style.border = '';
    const errorMsg = document.getElementById('editorError');
    if (errorMsg) errorMsg.remove();

    let cleanedContent = editorContent;
    cleanedContent = cleanedContent.replace(/<p><br><\/p>/g, '<br>');
    cleanedContent = cleanedContent.replace(/<p>\s*<\/p>/g, '');
    cleanedContent = cleanedContent.replace(/<div><br><\/div>/g, '<br>');
    cleanedContent = cleanedContent.replace(/<div>\s*<\/div>/g, '');

    description.value = cleanedContent;
});
</script>
{% endblock %}